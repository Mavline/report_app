# System Patterns

## High-Level Architecture
- Single-page React app
- All parsing/merge/export logic inside `src/App.tsx`
- In-memory processing of Excel workbooks using SheetJS and ExcelJS

## Merge Pattern (Current)
1. Parse workbook and selected sheets
2. Build row arrays (`sheetData`) from SheetJS
3. Build field mappings via drag-and-drop UI
4. Index right sheet by PN (`מקט`)
5. Iterate left sheet rows by PN (`ALE PN`)
6. For each mapped date column, locate qty value in left row
7. Join with right rows, calculate delivery/balance fields, build merged rows
8. Sort/group/process, preview, export

## Date Handling Invariants (Critical)
- UI-visible header labels used for drag-and-drop must be compatible with row keys produced by `XLSX.utils.sheet_to_json`.
- SheetJS may use formatted cell text (`cell.w`) for header keys; custom formatting in UI can cause key mismatches.
- Excel serial numbers must be converted consistently (UTC-safe) to avoid timezone drift.

## Current Date Strategy (post-2026-02-23 fixes)
- Use deterministic formatter for generated dates (`formatDateDeterministic`) instead of browser locale APIs for app-generated strings.
- Use `excelSerialToDate` with UTC semantics.
- Use `getCellDisplayValue(cell)`:
  - prefer `cell.w` (SheetJS formatted text)
  - fallback to deterministic formatting from `cell.v`
- Use `getValueByDateKey(row, label)` to try multiple variants when direct key lookup fails:
  - `Sep` / `Sept`
  - leading zero toggle in day
  - separator variants (space, dash, dot forms)

## Known Failure Pattern
Partial fixes that only normalize labels (`normalizeDate`) may still fail if UI labels and row keys are generated by different formatting systems.

## Validation Pattern Recommended
- Test with real uploaded files containing mixed date formats in header row
- Confirm both:
  - displayed header label in mapping panel
  - actual row key existence in parsed data
- Confirm merge returns rows (not empty) and triggers alert only on true no-match cases

